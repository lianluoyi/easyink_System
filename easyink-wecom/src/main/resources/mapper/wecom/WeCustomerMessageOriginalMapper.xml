<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.easyink.wecom.mapper.WeCustomerMessageOriginalMapper">
    <resultMap id="customerMessagePushVOMap" type="com.easyink.wecom.domain.vo.CustomerMessagePushVO">
        <id column="message_id" property="messageId"/>
        <result column="message_type" property="messageType"/>
        <result column="push_type" property="pushType"/>
        <result column="push_range" property="pushRange"/>
        <result column="sender" property="sender"/>
        <result column="sendTime" property="sendTime"/>
        <result column="content" property="content"/>
        <result column="chat_type" property="chatType"/>
        <result column="setting_time" property="settingTime"/>
        <result column="expect_send" property="expectSend"/>
        <result column="actual_send" property="actualSend"/>
        <result column="timed_task" property="timedTask"/>
        <result column="msgid" property="msgid"/>
        <result column="check_status" property="checkStatus"/>
        <collection property="seedMessageList" column="message_id"
                    ofType="com.easyink.wecom.domain.vo.WeCustomerSeedMessageVO"
                    select="selectSeedMessageByMsgId">

        </collection>
    </resultMap>
    
    <!-- 用于列表查询的 ResultMap，支持分批后的 messageIdDTOList -->
    <resultMap id="listMap" type="com.easyink.wecom.domain.vo.CustomerMessagePushVO">
        <result column="message_type" property="messageType"/>
        <result column="push_type" property="pushType"/>
        <result column="push_range" property="pushRange"/>
        <result column="task_name" property="taskName"/>
        <result column="sender" property="sender"/>
        <result column="departmentName" property="departmentName"/>
        <result column="sendTime" property="sendTime"/>
        <result column="message_id" property="messageId"/>
        <result column="content" property="content"/>
        <result column="chat_type" property="chatType"/>
        <result column="setting_time" property="settingTime"/>
        <result column="timed_task" property="timedTask"/>
        <result column="msgid" property="msgid"/>
        <result column="check_status" property="checkStatus"/>
        <result column="message_original_Id" property="messageOriginalId"/>
        <result column="expect_send" property="expectSend"/>
        <result column="actual_send" property="actualSend"/>
        <!-- 使用嵌套查询获取批次列表，传递 message_original_Id -->
        <collection property="messageIdDTOList" column="message_original_Id"
                    ofType="com.easyink.wecom.domain.dto.message.MessageIdDTO"
                    select="selectBatchListByOriginalId">
        </collection>
    </resultMap>
    
    <!-- 根据 message_original_Id 查询所有批次的 messageId 和 msgId -->
    <select id="selectBatchListByOriginalId" parameterType="java.lang.Long"
            resultType="com.easyink.wecom.domain.dto.message.MessageIdDTO">
        SELECT
            wcm.message_id as messageId,
            wcm.msgid as msgId
        FROM
            we_customer_message wcm
        WHERE
            wcm.original_id = #{message_original_Id}
            AND wcm.del_flag = ${@com.easyink.common.constant.WeConstans@WE_CUSTOMER_MSG_RESULT_NO_DEFALE}
    </select>
    <select id="selectSeedMessageByMsgId" parameterType="java.lang.Long"
            resultType="com.easyink.wecom.domain.WeCustomerSeedMessage">
        SELECT
            message_type,
            seed_message_id,
            message_id,
            media_id,
            miniprogram_media_id,
            appid,
            content,
            video_name,
            video_url,
            pic_name,
            pic_url,
            file_name,
            file_url,
            link_title,
            link_picurl,
            lin_desc,
            is_defined,
            link_url,
            miniprogram_title,
            page,
            create_by,
            create_time,
            update_by,
            update_time,
            extra_id
        FROM
            we_customer_seedmessage
        WHERE
            message_id = #{message_id}
    </select>
    <select id="selectCustomerMessagePushs" parameterType="com.easyink.wecom.domain.dto.WeCustomerMessageDTO"
            resultMap="listMap">
        SELECT
        wcmo.push_type,
        wcmo.message_type,
        wcmo.push_range,
        wcmo.task_name,
        IF(MIN(wcm.create_by) != 'admin',MIN(wu.user_name),MIN(wcm.create_by)) sender,
        MIN(wd.name) AS departmentName,
        wcmo.create_time sendTime,
        MIN(wcm.message_id) as message_id,
        MIN(wcm.content) as content,
        MIN(wcm.chat_type) as chat_type,
        MIN(wcm.setting_time) as setting_time,
        MIN(wcm.timed_task) as timed_task,
        GROUP_CONCAT(DISTINCT wcm.msgid SEPARATOR ',') as msgid,
        MIN(wcm.check_status) as check_status,
        wcmo.message_original_Id,
        SUM(wcm.expect_send) as expect_send,
        SUM(wcm.actual_send) as actual_send
        FROM
        we_customer_messageOriginal wcmo
        LEFT JOIN we_customer_message wcm ON wcmo.message_original_Id = wcm.original_id
        LEFT JOIN we_user wu ON wcm.create_by = wu.user_id and wcmo.corp_id = wu.corp_id
        LEFT JOIN we_department wd ON wu.main_department = wd.id and wd.corp_id = wcmo.corp_id
        <where>
            wcmo.corp_id = #{corpId}
            AND wcm.del_flag = ${@com.easyink.common.constant.WeConstans@WE_CUSTOMER_MSG_RESULT_NO_DEFALE}
            <if test="content!=null and content!=''">
                AND wcm.content LIKE CONCAT('%',#{content},'%')
            </if>
            <if test="pushType!=null and pushType!=''">
                AND wcmo.push_type=#{pushType}
            </if>
            <if test="beginTime != null and beginTime != ''"><!-- 开始时间检索 -->
                AND wcmo.create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null and endTime != ''"><!-- 结束时间检索 -->
                AND wcmo.create_time &lt;= #{endTime}
            </if>
            <if test="sender!=null and sender!=''">
                <choose>
                    <when test="sender == 'admin' ">
                        AND wcm.create_by LIKE CONCAT('%',#{sender},'%')
                    </when>
                    <otherwise>
                        AND wu.user_name LIKE CONCAT('%',#{sender},'%')
                    </otherwise>
                </choose>
            </if>
            <if test="adminFlag == false">
                ${params.dataScope}
            </if>
        </where>
        GROUP BY wcmo.message_original_Id
        ORDER BY wcmo.create_time DESC
    </select>
    <select id="findCustomerMessagePushDetail"
            resultMap="customerMessagePushVOMap">
        SELECT
        wcmo.push_type,
        wcmo.message_type,
        wcmo.push_range,
        wcmo.task_name,
        IF(MIN(wcm.create_by) != 'admin',MIN(wu.user_name),MIN(wcm.create_by)) sender,
        wcmo.create_time sendTime,
        MIN(wcm.message_id) as message_id,
        MIN(wcm.content) as content,
        GROUP_CONCAT(DISTINCT wcm.msgid SEPARATOR ',') as msgid,
        MIN(wcm.chat_type) as chat_type,
        MIN(wcm.setting_time) as setting_time,
        SUM(wcm.expect_send) as expect_send,
        SUM(wcm.actual_send) as actual_send,
        MIN(wcm.timed_task) as timed_task
        FROM
        we_customer_messageOriginal wcmo
        LEFT JOIN we_customer_message wcm ON wcmo.message_original_Id = wcm.original_id
        LEFT JOIN we_user wu ON wcm.create_by = wu.user_id and wu.corp_id = wcmo.corp_id
        <where>
            wcmo.message_original_Id = (
                SELECT original_id 
                FROM we_customer_message 
                WHERE message_id=#{messageId}
            )
            AND wcmo.corp_id = #{corpId}
            AND wcm.del_flag = ${@com.easyink.common.constant.WeConstans@WE_CUSTOMER_MSG_RESULT_NO_DEFALE}
        </where>
        GROUP BY wcmo.message_original_Id
    </select>
</mapper>